"""
Tests para el Caso de Uso: Sincronización del Layout del Sistema (UC-01)

Estos tests verifican el comportamiento del orquestador de sincronización
en las Fases 1-4 del algoritmo.
"""

import pytest
import sys
from pathlib import Path

# Agregar el directorio src al path
sys.path.insert(0, str(Path(__file__).parent.parent))

from application.use_cases import SyncSystemLayoutUseCase
from api.models.system_layout import (
    SystemLayoutModel,
    SiloConfigModel,
    CageConfigModel,
    FeedingLineConfigModel,
    BlowerConfigModel,
    DoserConfigModel,
    SelectorConfigModel,
    SlotAssignmentModel
)
from infrastructure.persistence.mock_repositories import (
    MockFeedingLineRepository,
    MockSiloRepository,
    MockCageRepository
)


@pytest.fixture
def repositories():
    """Fixture que proporciona repositorios mock limpios."""
    return {
        'line_repo': MockFeedingLineRepository(),
        'silo_repo': MockSiloRepository(),
        'cage_repo': MockCageRepository()
    }


@pytest.fixture
def use_case(repositories):
    """Fixture que proporciona una instancia del caso de uso."""
    return SyncSystemLayoutUseCase(
        line_repo=repositories['line_repo'],
        silo_repo=repositories['silo_repo'],
        cage_repo=repositories['cage_repo']
    )


@pytest.mark.anyio(backends=['asyncio'])
async def test_create_simple_system_layout(use_case):
    """
    Test: Crear un layout simple desde cero.
    
    Verifica:
    - Creación de silos, jaulas y líneas con IDs temporales
    - Mapeo correcto de IDs temporales a reales
    - Asignación de jaulas a slots
    """
    # Arrange: Preparar DTOs con IDs temporales
    request = SystemLayoutModel(
        silos=[
            SiloConfigModel(id="temp_silo_1", name="Silo A", capacity=1000.0)
        ],
        cages=[
            CageConfigModel(id="temp_cage_1", name="Jaula 1"),
            CageConfigModel(id="temp_cage_2", name="Jaula 2")
        ],
        feeding_lines=[
            FeedingLineConfigModel(
                id="temp_line_1",
                line_name="Linea Principal",
                blower_config=BlowerConfigModel(
                    id="temp_blower_1",
                    name="Soplador 1",
                    non_feeding_power=50.0,
                    blow_before_time=5,
                    blow_after_time=3
                ),
                dosers_config=[
                    DoserConfigModel(
                        id="temp_doser_1",
                        name="Dosificador 1",
                        assigned_silo_id="temp_silo_1",
                        doser_type="volumetric",
                        min_rate=10.0,
                        max_rate=100.0,
                        current_rate=50.0
                    )
                ],
                selector_config=SelectorConfigModel(
                    id="temp_selector_1",
                    name="Selector 1",
                    capacity=4,
                    fast_speed=80.0,
                    slow_speed=20.0
                ),
                slot_assignments=[
                    SlotAssignmentModel(slot_number=1, cage_id="temp_cage_1"),
                    SlotAssignmentModel(slot_number=2, cage_id="temp_cage_2")
                ]
            )
        ]
    )

    # Act: Ejecutar el caso de uso
    response = await use_case.execute(request)

    # Assert: Verificar respuesta
    assert response.status == "Sincronización completada"
    assert response.silos_processed == 1
    assert response.cages_processed == 2
    assert response.lines_processed == 1

    # Verificar que los agregados fueron creados
    all_silos = await use_case.silo_repo.get_all()
    all_cages = await use_case.cage_repo.list()
    all_lines = await use_case.line_repo.get_all()

    assert len(all_silos) == 1
    assert len(all_cages) == 2
    assert len(all_lines) == 1

    # Verificar que la línea tiene las asignaciones correctas
    line = all_lines[0]
    assert len(line.get_slot_assignments()) == 2


@pytest.mark.anyio(backends=['asyncio'])
async def test_update_existing_system_layout(use_case, repositories):
    """
    Test: Actualizar un layout existente.
    
    Verifica:
    - Actualización de agregados existentes usando UUIDs reales
    - Preservación de IDs reales
    """
    # Arrange: Crear un layout inicial
    initial_request = SystemLayoutModel(
        silos=[
            SiloConfigModel(id="temp_silo_1", name="Silo Original", capacity=1000.0)
        ],
        cages=[
            CageConfigModel(id="temp_cage_1", name="Jaula Original")
        ],
        feeding_lines=[
            FeedingLineConfigModel(
                id="temp_line_1",
                line_name="Linea Original",
                blower_config=BlowerConfigModel(
                    id="temp_blower_1",
                    name="Soplador 1",
                    non_feeding_power=50.0,
                    blow_before_time=5,
                    blow_after_time=3
                ),
                dosers_config=[
                    DoserConfigModel(
                        id="temp_doser_1",
                        name="Dosificador 1",
                        assigned_silo_id="temp_silo_1",
                        doser_type="volumetric",
                        min_rate=10.0,
                        max_rate=100.0,
                        current_rate=50.0
                    )
                ],
                selector_config=SelectorConfigModel(
                    id="temp_selector_1",
                    name="Selector 1",
                    capacity=2,
                    fast_speed=80.0,
                    slow_speed=20.0
                ),
                slot_assignments=[
                    SlotAssignmentModel(slot_number=1, cage_id="temp_cage_1")
                ]
            )
        ],
        relations_data={},
        presentation_data={}
    )

    await use_case.execute(initial_request)

    # Obtener IDs reales
    silos = await repositories['silo_repo'].get_all()
    cages = await repositories['cage_repo'].get_all()
    lines = await repositories['line_repo'].get_all()

    silo_id = str(silos[0].id)
    cage_id = str(cages[0].id)
    line_id = str(lines[0].id)

    # Act: Actualizar con IDs reales
    update_request = SystemLayoutModel(
        silos=[
            SiloConfigModel(id=silo_id, name="Silo Actualizado", capacity=1000.0)
        ],
        cages=[
            CageConfigModel(id=cage_id, name="Jaula Actualizada")
        ],
        feeding_lines=[
            FeedingLineConfigModel(
                id=line_id,
                line_name="Linea Actualizada",
                blower_config=BlowerConfigModel(
                    id="temp_blower_2",
                    name="Soplador Actualizado",
                    non_feeding_power=60.0,
                    blow_before_time=7,
                    blow_after_time=4
                ),
                dosers_config=[
                    DoserConfigModel(
                        id="temp_doser_2",
                        name="Dosificador Actualizado",
                        assigned_silo_id=silo_id,
                        doser_type="gravimetric",
                        min_rate=15.0,
                        max_rate=120.0,
                        current_rate=60.0
                    )
                ],
                selector_config=SelectorConfigModel(
                    id="temp_selector_2",
                    name="Selector Actualizado",
                    capacity=3,
                    fast_speed=85.0,
                    slow_speed=25.0
                ),
                slot_assignments=[
                    SlotAssignmentModel(slot_number=1, cage_id=cage_id)
                ]
            )
        ],
        relations_data={},
        presentation_data={}
    )

    response = await use_case.execute(update_request)

    # Assert: Verificar actualización
    assert response.status == "Sincronización completada"

    # Verificar que los nombres fueron actualizados
    updated_silo = await repositories['silo_repo'].find_by_id(silos[0].id)
    updated_cage = await repositories['cage_repo'].find_by_id(cages[0].id)
    updated_line = await repositories['line_repo'].find_by_id(lines[0].id)

    assert str(updated_silo.name) == "Silo Actualizado"
    assert str(updated_cage.name) == "Jaula Actualizada"
    assert str(updated_line.name) == "Linea Actualizada"


@pytest.mark.anyio(backends=['asyncio'])
async def test_delete_aggregates_not_in_request(use_case, repositories):
    """
    Test: Eliminar agregados que no están en el request.
    
    Verifica:
    - Fase 2: Eliminación de agregados ausentes en el request
    """
    # Arrange: Crear layout inicial con 2 silos
    initial_request = SystemLayoutModel(
        silos=[
            SiloConfigModel(id="temp_silo_1", name="Silo 1", capacity=1000.0),
            SiloConfigModel(id="temp_silo_2", name="Silo 2", capacity=2000.0)
        ],
        cages=[],
        feeding_lines=[],
        relations_data={},
        presentation_data={}
    )

    await use_case.execute(initial_request)

    # Verificar que hay 2 silos
    silos = await repositories['silo_repo'].get_all()
    assert len(silos) == 2

    silo_1_id = str(silos[0].id)

    # Act: Enviar request solo con 1 silo (el otro debe eliminarse)
    update_request = SystemLayoutModel(
        silos=[
            SiloConfigModel(id=silo_1_id, name="Silo 1", capacity=1000.0)
        ],
        cages=[],
        feeding_lines=[],
        relations_data={},
        presentation_data={}
    )

    response = await use_case.execute(update_request)

    # Assert: Verificar que solo queda 1 silo
    remaining_silos = await repositories['silo_repo'].get_all()
    assert len(remaining_silos) == 1
    assert str(remaining_silos[0].id) == silo_1_id
